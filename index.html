<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinGlass åˆ©ç‡ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #fafbfc;
            padding: 12px;
            line-height: 1.5;
            color: #2d3748;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .header {
            background: #f8fafc;
            color: #4a5568;
            padding: 16px 20px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .header h1 {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .header p {
            font-size: 0.875em;
            color: #718096;
        }

        .content {
            padding: 20px;
        }

        .section {
            margin-bottom: 12px;
            padding-bottom: 8px;
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            color: #4a5568;
            font-size: 0.875em;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.9em;
            background: #ffffff;
            transition: border-color 0.15s ease;
        }

        /* ç¡®ä¿æ—¶é—´è¾“å…¥æ¡†ä½¿ç”¨ç›¸åŒçš„å­—ä½“å¤§å° */
        input[type="time"] {
            font-size: 0.9em;
        }

        /* ä¸ºä¸‹æ‹‰æ¡†æ·»åŠ åˆé€‚çš„å³ä¾§paddingï¼Œç»™ä¸‹æ‹‰ç®­å¤´ç•™å‡ºç©ºé—´ */
        select {
            padding-right: 28px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
        }

        /* æ—¶é—´è¾“å…¥æ¡†çš„å›¾æ ‡å‰ç½®å’Œæ–‡å­—ç¼©è¿› */
        input[type="time"] {
            padding-left: 24px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='12' cy='12' r='10'%3e%3c/circle%3e%3cpolyline points='12,6 12,12 16,14'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 5px center;
            background-size: 12px;
        }

        /* éšè—æµè§ˆå™¨é»˜è®¤çš„æ—¶é—´å›¾æ ‡ */
        input[type="time"]::-webkit-calendar-picker-indicator {
            display: none;
        }

      
        input:focus, select:focus {
            outline: none;
            border-color: #718096;
            box-shadow: 0 0 0 1px #718096;
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 18px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: .15s ease;
            border-radius: 18px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .15s ease;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        input:checked + .slider {
            background-color: #718096;
        }

        input:checked + .slider:before {
            transform: translateX(18px);
        }

        /* ç›‘æ§æ¿€æ´»æ—¶çš„ç»¿è‰²ä¸»é¢˜ */
        .monitoring-active input:checked + .slider {
            background-color: #22c55e;
        }

        .btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.9em;
            cursor: pointer;
            width: 100%;
            border-radius: 4px;
            font-weight: 500;
            transition: background-color 0.15s ease;
        }

        .btn:hover {
            background: #2d3748;
        }

        .btn.secondary {
            background: #718096;
        }

        .btn.secondary:hover {
            background: #4a5568;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #fef5e7;
            border: 1px solid #f9e79f;
            padding: 12px 16px;
            margin-bottom: 8px;
            color: #7d6608;
            font-size: 0.9em;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        .success {
            background: #eafaf1;
            border: 1px solid #a9dfbf;
            color: #239b56;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading {
            text-align: center;
            padding: 16px;
            color: #718096;
            font-size: 0.9em;
        }

        .main-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 12px 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .main-toggle.monitoring-active {
            background: #f0fdf4;
            border: 1px solid #86efac;
        }

        .main-toggle h3 {
            color: #2d3748;
            font-size: 1em;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .main-toggle.monitoring-active h3 {
            color: #166534;
        }

        /* ç›‘æ§åˆ—è¡¨æ ·å¼ */
        .monitor-list {
            margin-top: 12px;
        }

        .monitor-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .monitor-info {
            flex: 1;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .monitor-info strong {
            color: #2d3748;
            font-size: 1em;
        }

        .monitor-info .timeframe {
            color: #718096;
            font-weight: normal;
            font-size: 1em;
        }

        .monitor-info small {
            color: #718096;
            font-size: 1em;
        }

        .monitor-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remove-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
        }

        .remove-btn:hover {
            background: #c53030;
        }

        .edit-btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            margin-right: 4px;
        }

        .edit-btn:hover {
            background: #2c5282;
        }

        .cooldown-btn {
            background: #f8fafc;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            margin-right: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .cooldown-btn:hover {
            background: #edf2f7;
            border-color: #a0aec0;
        }

        .cooldown-btn:disabled {
            background: #f7fafc;
            color: #a0aec0;
            border-color: #e2e8f0;
            cursor: not-allowed;
        }

        .cooldown-icon {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }

        /* ç›‘æ§é¡¹ä¿¡æ¯æ ·å¼ */
        .monitor-info .secondary-info {
            font-size: 0.8em;
            color: #6b7280;
            line-height: 1.4;
        }

        .monitor-info .status-text {
            font-weight: 600;
        }

        /* å¿«é€Ÿæ·»åŠ ç›‘æ§æ ·å¼ */
        .add-monitor-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .add-monitor-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-monitor-input label {
            min-width: 60px;
            font-size: 0.875em;
            color: #4a5568;
            font-weight: 500;
        }

        .add-monitor-input input,
        .add-monitor-input select {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .add-btn {
            background: #ffffff;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            align-self: flex-start;
        }

        .add-btn:hover {
            background: #f8fafc;
            border-color: #718096;
        }

        .icon-btn {
            background: #ffffff;
            color: #718096;
            border: 1px solid #cbd5e0;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            line-height: 1;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover:not(:disabled) {
            background: #f8fafc;
            border-color: #718096;
            color: #4a5568;
        }

        .icon-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* ä¸¤æ å¸ƒå±€æ ·å¼ */
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        @media (max-width: 900px) {
            .two-column-layout {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        @media (max-width: 600px) {
            .content {
                padding: 16px;
            }
            .add-monitor-row {
                flex-direction: column;
                gap: 8px;
            }
            .add-monitor-row input,
            .add-monitor-row select {
                min-width: auto;
            }
            .time-inputs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CoinGlass åˆ©ç‡ç›‘æ§</h1>
            <p>å®æ—¶ç›‘æ§å¸ç§å€Ÿè´·åˆ©ç‡</p>
        </div>

        <div class="content">
            <div id="alerts"></div>

            <!-- ä¸»ç›‘æ§å¼€å…³ -->
            <div class="section">
                <div class="main-toggle" id="mainToggleContainer">
                    <h3 id="monitorStatusTitle">ç›‘æ§çŠ¶æ€</h3>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mainToggle" onchange="handleMainToggleChange()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- ä¸¤æ å¸ƒå±€ -->
            <div class="two-column-layout">
                <!-- å·¦æ ï¼šç›‘æ§é¡¹ç›®ç®¡ç† -->
                <div class="left-column">
                    <!-- æ·»åŠ ç›‘æ§ -->
                    <div class="section">
                        <h2>æ·»åŠ ç›‘æ§</h2>

                        <div class="add-monitor-row">
                            <div class="add-monitor-input">
                                <label>äº¤æ˜“æ‰€:</label>
                                <select id="quickExchange">
                                    <option value="binance">Binance</option>
                                    <option value="okx">OKX</option>
                                    <option value="bybit">Bybit</option>
                                </select>
                            </div>

                            <div class="add-monitor-input">
                                <label>å¸ç§:</label>
                                <input type="text" id="quickCoin" placeholder="å¸ç§" value="USDT">
                            </div>

                            <div class="add-monitor-input">
                                <label>é¢—ç²’åº¦:</label>
                                <select id="quickTimeframe">
                                    <option value="1h">æ¯å°æ—¶</option>
                                    <option value="24h">æ¯å¤©</option>
                                </select>
                            </div>

                            <div class="add-monitor-input">
                                <label>é˜ˆå€¼%:</label>
                                <input type="number" id="quickThreshold" placeholder="é˜ˆå€¼%" step="0.1" min="0">
                            </div>

                            <button onclick="addMonitor()" class="btn" style="width: 100%;">æ·»åŠ ç›‘æ§</button>
                        </div>
                    </div>

                    <!-- ç›‘æ§åˆ—è¡¨ -->
                    <div class="section">
                        <div style="display: flex; align-items: center; margin-bottom: 12px; gap: 8px;">
                            <h2 style="margin: 0;">ç›‘æ§åˆ—è¡¨</h2>
                            <button id="triggerBtn" onclick="triggerMonitoring()" class="icon-btn" title="ç«‹å³è§¦å‘">â–¶</button>
                            <span id="triggerStatus" style="font-size: 12px; color: #6b7280; display: none;"></span>
                        </div>
                        <div id="monitorList" class="monitor-list">
                            <p style="text-align: center; color: #6b7280;">æš‚æ— ç›‘æ§é¡¹ç›®</p>
                        </div>
                    </div>
                </div>

                <!-- å³æ ï¼šé€šçŸ¥è®¾ç½® -->
                <div class="right-column">
                    <!-- é€šçŸ¥è®¾ç½® -->
                    <div class="section">
                        <h2>é€šçŸ¥è®¾ç½®</h2>

                        <div class="form-group">
                            <label for="email">é€šçŸ¥é‚®ç®±</label>
                            <input type="email" id="email" placeholder="your-email@example.com" onchange="autoSaveConfig()">
                        </div>

                        <div class="form-group">
                            <label for="repeatInterval">é‡å¤é€šçŸ¥é—´éš” (åˆ†é’Ÿ)</label>
                            <input type="number" id="repeatInterval" min="1" max="10080" value="180" placeholder="180" onchange="autoSaveConfig()">
                        </div>

                        <div class="form-group">
                            <label for="hourlyMinute">æ¯å°æ—¶è§¦å‘æ—¶æœº (åˆ†é’Ÿ)</label>
                            <input type="number" id="hourlyMinute" min="0" max="59" value="5" placeholder="5" onchange="autoSaveConfig()">
                        </div>

                        <div class="form-group">
                            <label for="dailyTime">æ¯å¤©è§¦å‘æ—¶æœº (H:MM)</label>
                            <input type="time" id="dailyTime" value="09:05" onchange="autoSaveConfig()">
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="timeControl" style="width: auto; margin-right: 8px;" onchange="toggleTimeInputs(); autoSaveConfig()">
                                å¯ç”¨æ—¶é—´é™åˆ¶
                            </label>
                        </div>

                        <div id="timeInputs" style="display: none;">
                            <div class="form-group">
                                <label for="startTime">å¼€å§‹æ—¶é—´</label>
                                <input type="time" id="startTime" value="09:00" onchange="autoSaveConfig()">
                            </div>

                            <div class="form-group">
                                <label for="endTime">ç»“æŸæ—¶é—´</label>
                                <input type="time" id="endTime" value="23:59" onchange="autoSaveConfig()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ—¥å¿—å®¹å™¨ -->
            <div class="section">
                <h2>ç³»ç»Ÿæ—¥å¿—
                    <div style="float: right;">
                        <button onclick="copyLogs()" style="font-size: 12px; padding: 4px 8px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; margin-right: 4px;">å¤åˆ¶</button>
                        <button onclick="clearLogs()" style="font-size: 12px; padding: 4px 8px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer;">æ¸…ç©º</button>
                    </div>
                </h2>
                <div id="logContainer" style="background: #1a1a1a; color: #ffffff; padding: 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; height: 350px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #374151;">
                    <div style="color: #9ca3af; text-align: center;">ç­‰å¾…ç³»ç»Ÿæ—¥å¿—...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Webç•Œé¢é€»è¾‘ - æ¢å¤åŸå§‹å®ç°
        const API_BASE = window.location.origin;
        let currentConfig = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆåŠ è½½é…ç½®ï¼Œç„¶ååŠ è½½çŠ¶æ€
            loadConfig().then(() => {
                loadStatus();
            }).catch(() => {
                // å¦‚æœé…ç½®åŠ è½½å¤±è´¥ï¼Œä»ç„¶å°è¯•åŠ è½½çŠ¶æ€
                loadStatus();
            });

            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
            setInterval(loadStatus, 30000);
        });

        // æ·»åŠ ç›‘æ§
        function addMonitor() {
            const exchange = document.getElementById('quickExchange').value;
            const coin = document.getElementById('quickCoin').value.trim().toUpperCase();
            const timeframe = document.getElementById('quickTimeframe').value;
            const threshold = parseFloat(document.getElementById('quickThreshold').value);

            // éªŒè¯è¾“å…¥
            if (!coin) {
                showAlert('è¯·è¾“å…¥å¸ç§');
                return;
            }

            if (!threshold || threshold <= 0) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„é˜ˆå€¼');
                return;
            }

            // è·å–å½“å‰é…ç½®
            const config = currentConfig || {};
            if (!config.coins) config.coins = [];

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ç›‘æ§
            const exists = config.coins.some(c =>
                c.symbol === coin && c.exchange === exchange && c.timeframe === timeframe
            );

            if (exists) {
                showAlert('è¯¥ç›‘æ§å·²å­˜åœ¨');
                return;
            }

            // æ·»åŠ æ–°ç›‘æ§
            config.coins.push({
                symbol: coin,
                exchange: exchange,
                timeframe: timeframe,
                threshold: threshold,
                enabled: true
            });

            // ä¿å­˜é…ç½®
            saveConfig(config);

            // æ¸…ç©ºè¾“å…¥
            document.getElementById('quickCoin').value = '';
            document.getElementById('quickThreshold').value = '';

            // æ£€æŸ¥æ˜¯å¦éœ€è¦è¯¢é—®å¯ç”¨ç›‘æ§
            checkAndAskToEnableMonitoring();

            loadStatus();
            // æ›´æ–°ç›‘æ§å¼€å…³çŠ¶æ€
            updateMonitoringToggle();
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'error') {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;

            // è®¡ç®—å‚ç›´ä½ç½®ï¼Œè®©é€šçŸ¥å‚ç›´æ’åˆ—
            const existingAlerts = document.querySelectorAll('.alert');
            const topOffset = 20 + (existingAlerts.length * 60); // æ¯ä¸ªé€šçŸ¥é—´éš”60px
            alert.style.top = `${topOffset}px`;

            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    alert.remove();
                    // é‡æ–°æ’åˆ—å‰©ä½™çš„é€šçŸ¥
                    rearrangeAlerts();
                }, 300);
            }, 5000);
        }

        // é‡æ–°æ’åˆ—é€šçŸ¥ä½ç½®
        function rearrangeAlerts() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach((alert, index) => {
                const topOffset = 20 + (index * 60);
                alert.style.top = `${topOffset}px`;
            });
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/config`);
                const config = await response.json();

                if (config && Object.keys(config).length > 0) {
                    currentConfig = config;
                    populateForm(config);
                    showAlert('é…ç½®åŠ è½½æˆåŠŸ', 'success');
                    return config;
                }
                return null;
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                showAlert('åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
                return null;
            }
        }

        // å¡«å……è¡¨å•
        function populateForm(config) {
            document.getElementById('email').value = config.email || '';
            document.getElementById('repeatInterval').value = config.repeat_interval || 180;
            document.getElementById('mainToggle').checked = config.monitoring_enabled || false;

            // å¡«å……è§¦å‘æ—¶é—´è®¾ç½®
            if (config.trigger_settings) {
                document.getElementById('hourlyMinute').value = config.trigger_settings.hourly_minute || 5;
                document.getElementById('dailyTime').value = config.trigger_settings.daily_time || '09:05';
            }

            if (config.notification_hours) {
                document.getElementById('timeControl').checked = config.notification_hours.enabled || false;
                document.getElementById('startTime').value = config.notification_hours.start || '09:00';
                document.getElementById('endTime').value = config.notification_hours.end || '23:59';
                // æ ¹æ®å¤é€‰æ¡†çŠ¶æ€æ˜¾ç¤ºæˆ–éšè—æ—¶é—´è¾“å…¥
                toggleTimeInputs();
            }

            // æ›´æ–°ç›‘æ§å¼€å…³çŠ¶æ€
            updateMonitoringToggle();
        }

        // ä¿å­˜é…ç½®
        async function saveConfig(inputConfig = null) {
            const config = inputConfig || {
                email: document.getElementById('email').value,
                repeat_interval: parseInt(document.getElementById('repeatInterval').value),
                monitoring_enabled: document.getElementById('mainToggle').checked,
                trigger_settings: {
                    hourly_minute: parseInt(document.getElementById('hourlyMinute').value) || 5,
                    daily_time: document.getElementById('dailyTime').value || '09:05'
                },
                notification_hours: {
                    enabled: document.getElementById('timeControl').checked,
                    start: document.getElementById('startTime').value,
                    end: document.getElementById('endTime').value
                },
                coins: currentConfig?.coins || [] // ä¿æŒç°æœ‰çš„ç›‘æ§é…ç½®
            };

            try {
                const response = await fetch(`${API_BASE}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    if (!inputConfig) {
                        showAlert('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    }
                    currentConfig = config;
                } else {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                if (!inputConfig) {
                    showAlert('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        // åŠ è½½çŠ¶æ€
        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();

                updateSystemStatus(true);
                displayStatus(data);
            } catch (error) {
                console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
                updateSystemStatus(false);
                document.getElementById('monitorList').innerHTML =
                    '<p style="text-align: center; color: #ef4444;">çŠ¶æ€åŠ è½½å¤±è´¥</p>';
            }
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function updateSystemStatus(isOnline) {
            // ç§»é™¤äº†çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ŒåŠŸèƒ½ä¿ç•™ä½†ç®€åŒ–
        }

        // æ˜¾ç¤ºç›‘æ§åˆ—è¡¨
        function displayStatus(data) {
            const container = document.getElementById('monitorList');
            const config = currentConfig || {};

            // å¦‚æœé…ç½®è¿˜æœªåŠ è½½ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (!currentConfig) {
                container.innerHTML = '<p style="text-align: center; color: #3b82f6;">æ­£åœ¨åŠ è½½é…ç½®...</p>';
                return;
            }

            if (!config.coins || config.coins.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">æš‚æ— ç›‘æ§é¡¹ç›®</p>';
                return;
            }

            let html = '';

            config.coins.forEach((coin, index) => {
                const state = data.monitoring_status && data.monitoring_status.coins_state && data.monitoring_status.coins_state[coin.symbol] ? data.monitoring_status.coins_state[coin.symbol] : { status: 'normal' };
                const statusClass = state.status === 'alert' ? '#ef4444' :
                                   state.status === 'normal' ? '#10b981' : '#f59e0b';
                const statusText = state.status === 'alert' ? 'è­¦æŠ¥' :
                                  state.status === 'normal' ? 'æ­£å¸¸' : 'å†·å´ä¸­';

                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                const timeframeText = coin.timeframe === '1h' ? 'æ¯å°æ—¶' :
                                    coin.timeframe === '24h' ? 'æ¯å¤©' : coin.timeframe;

                // è®¡ç®—ä¸‹æ¬¡é€šçŸ¥æ—¶é—´
                let nextNotificationText = '';
                if (state.status === 'alert' && state.next_notification) {
                    const nextTime = new Date(state.next_notification);
                    const now = new Date();
                    const diffMs = nextTime - now;

                    if (diffMs > 0) {
                        const diffMins = Math.floor(diffMs / (1000 * 60));
                        if (diffMins < 60) {
                            nextNotificationText = ' <small style="color: #6b7280;">(' + diffMins + 'åˆ†é’Ÿåé€šçŸ¥)</small>';
                        } else {
                            const diffHours = Math.floor(diffMins / 60);
                            const remainingMins = diffMins % 60;
                            if (diffHours < 24) {
                                nextNotificationText = ' <small style="color: #6b7280;">(' + diffHours + 'å°æ—¶' + (remainingMins > 0 ? remainingMins + 'åˆ†é’Ÿ' : '') + 'åé€šçŸ¥)</small>';
                            } else {
                                const diffDays = Math.floor(diffHours / 24);
                                const remainingHours = diffHours % 24;
                                nextNotificationText = ' <small style="color: #6b7280;">(' + diffDays + 'å¤©' + (remainingHours > 0 ? remainingHours + 'å°æ—¶' : '') + 'åé€šçŸ¥)</small>';
                            }
                        }
                    }
                }

                // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºæš‚åœ/ç»§ç»­æŒ‰é’®ï¼ˆåœ¨è­¦æŠ¥çŠ¶æ€æ—¶æ˜¾ç¤ºï¼‰
                const showPauseBtn = state.status === 'alert';
                const pauseBtn = showPauseBtn ?
                    '<button onclick="togglePause(\'' + coin.symbol + '\')" class="cooldown-btn" title="æš‚åœ/ç»§ç»­é€šçŸ¥">' +
                        '<svg class="cooldown-icon" viewBox="0 0 24 24">' +
                            '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>' +
                        '</svg>' +
                    '</button>' : '';

                html += '<div class="monitor-item">' +
                        '<div class="monitor-info">' +
                            '<strong>' + coin.exchange + ' - ' + coin.symbol + '</strong> ' +
                            '<span class="timeframe">(' + timeframeText + ')</span>' +
                            '<div class="secondary-info">' +
                            'é˜ˆå€¼: ' + coin.threshold + '% | çŠ¶æ€: ' +
                            '<span class="status-text" style="color: ' + statusClass + ';">' + statusText + '</span>' +
                            nextNotificationText +
                        '</div>' +
                        '</div>' +
                        '<div class="monitor-actions">' +
                            pauseBtn +
                            '<button onclick="editMonitor(' + index + ')" class="edit-btn">ç¼–è¾‘</button>' +
                            '<button onclick="removeMonitor(' + index + ')" class="remove-btn">åˆ é™¤</button>' +
                        '</div>' +
                    '</div>';
            });

            container.innerHTML = html;
        }

  
        // ç¼–è¾‘ç›‘æ§
        function editMonitor(index) {
            const config = currentConfig || {};
            if (config.coins && config.coins[index]) {
                const coin = config.coins[index];
                const currentThreshold = coin.threshold;
                const newThreshold = prompt(`ç¼–è¾‘ ${coin.exchange} - ${coin.symbol} çš„é˜ˆå€¼:`, currentThreshold);

                if (newThreshold !== null) {
                    const parsedThreshold = parseFloat(newThreshold);
                    if (!isNaN(parsedThreshold) && parsedThreshold > 0) {
                        config.coins[index].threshold = parsedThreshold;
                        saveConfig(config);
                        showAlert('é˜ˆå€¼å·²æ›´æ–°', 'success');
                        loadStatus();
                    } else {
                        showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„é˜ˆå€¼æ•°å€¼', 'error');
                    }
                }
            }
        }

        // åˆ é™¤ç›‘æ§
        function removeMonitor(index) {
            const config = currentConfig || {};
            if (config.coins && config.coins[index]) {
                const coin = config.coins[index];
                if (confirm('ç¡®å®šè¦åˆ é™¤ç›‘æ§ ' + coin.exchange + ' - ' + coin.symbol + ' å—ï¼Ÿ')) {
                    config.coins.splice(index, 1);
                    saveConfig(config);
                    showAlert('ç›‘æ§å·²åˆ é™¤', 'success');
                    loadStatus();
                    // æ›´æ–°ç›‘æ§å¼€å…³çŠ¶æ€
                    updateMonitoringToggle();
                }
            }
        }

        // æš‚åœ/ç»§ç»­é€šçŸ¥
        async function togglePause(coinSymbol) {
            try {
                const response = await fetch(`${API_BASE}/api/status/cooldown/reset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ coinSymbol })
                });

                const result = await response.json();

                if (result.success) {
                    // åˆ·æ–°çŠ¶æ€æ˜¾ç¤ºï¼Œä¸æ˜¾ç¤ºæç¤º
                    loadStatus();
                } else {
                    // é™é»˜å¤±è´¥ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                    console.log('æš‚åœ/ç»§ç»­æ“ä½œå¤±è´¥:', result.message);
                }
            } catch (error) {
                // é™é»˜å¤±è´¥
                console.error('æš‚åœ/ç»§ç»­æ“ä½œå¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢æ—¶é—´è¾“å…¥æ˜¾ç¤º
        function toggleTimeInputs() {
            const timeControl = document.getElementById('timeControl');
            const timeInputs = document.getElementById('timeInputs');

            if (timeControl.checked) {
                timeInputs.style.display = 'block';
            } else {
                timeInputs.style.display = 'none';
            }
        }

        // æ£€æŸ¥ç›‘æ§çŠ¶æ€æ˜¯å¦å¯ä»¥å¼€å¯
        function canEnableMonitoring() {
            const email = document.getElementById('email').value.trim();
            const config = currentConfig || {};
            const hasCoins = config.coins && config.coins.length > 0;

            // æ£€æŸ¥é‚®ç®±æ ¼å¼æ˜¯å¦æœ‰æ•ˆ
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isValidEmail = !email || emailRegex.test(email);

            return isValidEmail && hasCoins;
        }

        // å¤„ç†ä¸»ç›‘æ§å¼€å…³ç‚¹å‡»
        function handleMainToggleChange() {
            const mainToggle = document.getElementById('mainToggle');
            const canEnable = canEnableMonitoring();

            if (mainToggle.checked && !canEnable) {
                // é˜»æ­¢å¼€å¯ç›‘æ§
                mainToggle.checked = false;
                showEnableMonitoringError();
                return;
            }

            // å¦‚æœå¯ä»¥å¼€å¯ï¼Œåˆ™ä¿å­˜é…ç½®
            autoSaveConfig();
        }

        // æ£€æŸ¥å¹¶è¯¢é—®å¯ç”¨ç›‘æ§
        function checkAndAskToEnableMonitoring() {
            const email = document.getElementById('email').value.trim();
            const mainToggle = document.getElementById('mainToggle');
            const config = currentConfig || {};
            const coinCount = config.coins ? config.coins.length : 0;

            // å¦‚æœé‚®ç®±å·²å¡«å†™ï¼Œç›‘æ§æœªå¼€å¯ï¼Œä¸”è¿™æ˜¯ç¬¬ä¸€æ¡ç›‘æ§
            if (email && !mainToggle.checked && coinCount === 1) {
                setTimeout(() => {
                    if (confirm('ç›‘æ§æ·»åŠ æˆåŠŸï¼æ˜¯å¦ç«‹å³å¼€å¯ç›‘æ§ï¼Ÿ')) {
                        mainToggle.checked = true;
                        autoSaveConfig();
                        showAlert('ç›‘æ§å·²å¯ç”¨ï¼Œç³»ç»Ÿå°†æŒ‰é…ç½®æ‰§è¡Œæ£€æŸ¥', 'success');
                    } else {
                        showAlert('ç›‘æ§æ·»åŠ æˆåŠŸï¼è¯·è®°å¾—å¼€å¯ç›‘æ§å¼€å…³ä»¥å¼€å§‹ç›‘æ§', 'success');
                    }
                }, 500);
            } else {
                // å…¶ä»–æƒ…å†µæ˜¾ç¤ºå¸¸è§„æç¤º
                showAlert('ç›‘æ§æ·»åŠ æˆåŠŸï¼' + getMonitoringEnabledTip(), 'success');
            }
        }

        // è·å–ç›‘æ§å¯ç”¨æç¤ºä¿¡æ¯
        function getMonitoringEnabledTip() {
            const email = document.getElementById('email').value.trim();
            const mainToggle = document.getElementById('mainToggle');
            const isEnabled = mainToggle.checked;

            if (!email && !isEnabled) {
                return ' è¯·å¡«å†™é€šçŸ¥é‚®ç®±å¹¶å¼€å¯ç›‘æ§å¼€å…³ä»¥å¼€å§‹ç›‘æ§';
            } else if (!email) {
                return ' è¯·å¡«å†™é€šçŸ¥é‚®ç®±ä»¥æ¥æ”¶ç›‘æ§é€šçŸ¥';
            } else if (!isEnabled) {
                return ' è¯·å¼€å¯ç›‘æ§å¼€å…³ä»¥å¼€å§‹ç›‘æ§';
            } else {
                return ' ç›‘æ§å·²å¯ç”¨ï¼Œç³»ç»Ÿå°†æŒ‰é…ç½®æ‰§è¡Œæ£€æŸ¥';
            }
        }

        // æ˜¾ç¤ºå…·ä½“çš„å¯ç”¨é”™è¯¯æç¤º
        function showEnableMonitoringError() {
            const email = document.getElementById('email').value.trim();
            const config = currentConfig || {};
            const hasCoins = config.coins && config.coins.length > 0;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isValidEmail = !email || emailRegex.test(email);

            if (!isValidEmail && !hasCoins) {
                if (!email) {
                    showAlert('è¯·å…ˆå¡«å†™é€šçŸ¥é‚®ç®±å¹¶æ·»åŠ ç›‘æ§é¡¹ç›®', 'error');
                } else {
                    showAlert('è¯·å¡«å†™æœ‰æ•ˆçš„é€šçŸ¥é‚®ç®±å¹¶æ·»åŠ ç›‘æ§é¡¹ç›®', 'error');
                }
            } else if (!isValidEmail) {
                if (!email) {
                    showAlert('è¯·å…ˆå¡«å†™é€šçŸ¥é‚®ç®±', 'error');
                } else {
                    showAlert('è¯·å¡«å†™æœ‰æ•ˆçš„é€šçŸ¥é‚®ç®±', 'error');
                }
            } else if (!hasCoins) {
                showAlert('è¯·å…ˆæ·»åŠ ç›‘æ§é¡¹ç›®', 'error');
            }
        }

        // æ›´æ–°ç›‘æ§å¼€å…³çŠ¶æ€
        function updateMonitoringToggle() {
            const mainToggle = document.getElementById('mainToggle');
            const container = document.getElementById('mainToggleContainer');
            const title = document.getElementById('monitorStatusTitle');
            const canEnable = canEnableMonitoring();

            if (!canEnable && mainToggle.checked) {
                // å¦‚æœå½“å‰å¼€å¯ä½†ä¸æ»¡è¶³æ¡ä»¶ï¼Œè‡ªåŠ¨å…³é—­
                mainToggle.checked = false;
                showAlert('ç›‘æ§å·²è‡ªåŠ¨å…³é—­ï¼šéœ€è¦é…ç½®é€šçŸ¥é‚®ç®±å’Œç›‘æ§é¡¹ç›®', 'error');
                // ä¿å­˜é…ç½®
                autoSaveConfig();
            }

            // ä¸ç¦ç”¨å¼€å…³ï¼Œä½†æ”¹å˜æ ·å¼æ¥æç¤ºç”¨æˆ·
            if (!canEnable) {
                mainToggle.style.opacity = '0.5';
                // ä¸è®¾ç½®disabledï¼Œä¿æŒå¯ç‚¹å‡»
            } else {
                mainToggle.style.opacity = '1';
            }

            // æ›´æ–°ç›‘æ§æ¿€æ´»çŠ¶æ€çš„è§†è§‰åé¦ˆ
            if (mainToggle.checked && canEnable) {
                container.classList.add('monitoring-active');
                title.textContent = 'åˆ©ç‡å˜åŒ–ç›‘æ§ä¸­...';
            } else {
                container.classList.remove('monitoring-active');
                title.textContent = 'ç›‘æ§çŠ¶æ€ï¼šæœªå¼€å¯';
            }
        }

        // è‡ªåŠ¨ä¿å­˜é…ç½®
        async function autoSaveConfig() {
            const config = {
                email: document.getElementById('email').value,
                repeat_interval: parseInt(document.getElementById('repeatInterval').value),
                monitoring_enabled: document.getElementById('mainToggle').checked,
                trigger_settings: {
                    hourly_minute: parseInt(document.getElementById('hourlyMinute').value) || 5,
                    daily_time: document.getElementById('dailyTime').value || '09:05'
                },
                notification_hours: {
                    enabled: document.getElementById('timeControl').checked,
                    start: document.getElementById('startTime').value,
                    end: document.getElementById('endTime').value
                },
                coins: currentConfig?.coins || []
            };

            // æ£€æŸ¥ç›‘æ§çŠ¶æ€è§„åˆ™
            const canEnable = canEnableMonitoring();
            if (config.monitoring_enabled && !canEnable) {
                config.monitoring_enabled = false;
                document.getElementById('mainToggle').checked = false;
                showAlert('ç›‘æ§å¼€å¯å¤±è´¥ï¼šéœ€è¦é…ç½®é€šçŸ¥é‚®ç®±å’Œç›‘æ§é¡¹ç›®', 'error');
            }

            try {
                const response = await fetch(`${API_BASE}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    currentConfig = config;
                    showAlert('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    // æ›´æ–°ç›‘æ§å¼€å…³çŠ¶æ€
                    updateMonitoringToggle();
                } else {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('è‡ªåŠ¨ä¿å­˜é…ç½®å¤±è´¥:', error);
                showAlert('é…ç½®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ç«‹å³è§¦å‘ç›‘æ§
        async function triggerMonitoring() {
            const triggerBtn = document.getElementById('triggerBtn');
            const triggerStatus = document.getElementById('triggerStatus');

            // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å·²ç»åœ¨æ‰§è¡Œä¸­
            if (triggerBtn.disabled) {
                return;
            }

            try {
                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºè¿›åº¦
                triggerBtn.disabled = true;
                triggerBtn.style.opacity = '0.5';
                triggerBtn.textContent = 'â³';
                triggerStatus.style.display = 'inline';
                triggerStatus.textContent = 'æ­£åœ¨å¯åŠ¨æµè§ˆå™¨...';

                showAlert('æ­£åœ¨è§¦å‘ç›‘æ§æ£€æŸ¥...', 'info');

                // å¯åŠ¨è¿›åº¦æ›´æ–°åºåˆ—ï¼ˆåŸºäºå®Œæ•´ç›‘æ§æµç¨‹ï¼‰
                const progressSteps = [
                    { time: 1000, text: 'è®¿é—®CoinGlassé¡µé¢...' },
                    { time: 3000, text: 'åˆ‡æ¢äº¤æ˜“æ‰€...' },
                    { time: 5000, text: 'é€‰æ‹©å¸ç§...' },
                    { time: 7000, text: 'æå–æ•°æ®...' },
                    { time: 9000, text: 'æ£€æŸ¥é˜ˆå€¼æ¡ä»¶...' },
                    { time: 11000, text: 'å‘é€é€šçŸ¥é‚®ä»¶...' }
                ];

                const progressTimers = [];
                progressSteps.forEach(step => {
                    const timer = setTimeout(() => {
                        if (triggerBtn.disabled) {
                            triggerStatus.textContent = step.text;
                        }
                    }, step.time);
                    progressTimers.push(timer);
                });

                // è°ƒç”¨æ­£ç¡®çš„APIç«¯ç‚¹
                const response = await fetch(`${API_BASE}/api/scrape/coinglass`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                // æ¸…é™¤æ‰€æœ‰è¿›åº¦å®šæ—¶å™¨
                progressTimers.forEach(timer => clearTimeout(timer));

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                triggerStatus.textContent = 'å®Œæˆï¼';
                triggerBtn.textContent = 'âœ“';
                triggerBtn.style.color = '#10b981';

                // æ ¹æ®ç›‘æ§ç»“æœæ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸæ¶ˆæ¯
                let successMessage = 'ç›‘æ§è§¦å‘æˆåŠŸï¼';
                if (data.monitor_results) {
                  const { alerts_sent, recoveries_sent, coins_checked } = data.monitor_results;
                  if (alerts_sent > 0) {
                    successMessage += ` å·²å‘é€ ${alerts_sent} ä¸ªè­¦æŠ¥é€šçŸ¥`;
                  } else if (recoveries_sent > 0) {
                    successMessage += ` å·²å‘é€ ${recoveries_sent} ä¸ªæ¢å¤é€šçŸ¥`;
                  } else {
                    successMessage += ` æ£€æŸ¥äº† ${coins_checked} ä¸ªå¸ç§ï¼Œåˆ©ç‡æ­£å¸¸`;
                  }
                }

                showAlert(successMessage, 'success');

                // è§¦å‘ååˆ·æ–°çŠ¶æ€
                setTimeout(() => {
                    loadStatus();
                }, 2000);

                // 3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    resetTriggerButton();
                }, 3000);

            } catch (error) {
                console.error('è§¦å‘ç›‘æ§å¤±è´¥:', error);

                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                triggerStatus.textContent = 'å¤±è´¥';
                triggerBtn.textContent = 'âœ—';
                triggerBtn.style.color = '#ef4444';

                showAlert(`è§¦å‘ç›‘æ§å¤±è´¥: ${error.message}`, 'error');

                // 3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    resetTriggerButton();
                }, 3000);
            }
        }

        // æ¢å¤è§¦å‘æŒ‰é’®çŠ¶æ€çš„å‡½æ•°
        function resetTriggerButton() {
            const triggerBtn = document.getElementById('triggerBtn');
            const triggerStatus = document.getElementById('triggerStatus');

            if (triggerBtn) {
                triggerBtn.disabled = false;
                triggerBtn.style.opacity = '1';
                triggerBtn.style.color = '';
                triggerBtn.textContent = 'â–¶';
            }

            if (triggerStatus) {
                triggerStatus.style.display = 'none';
                triggerStatus.textContent = '';
            }
        }

        // æ—¥å¿—åŠŸèƒ½ç›¸å…³å˜é‡å’Œå‡½æ•°
        let logUpdateInterval = null;
        let lastLogCount = 0;

        // é¢œè‰²æ˜ å°„å‡½æ•° - æ ¹æ®æ—¥å¿—å†…å®¹è®¾ç½®é¢œè‰²
        function getLogColor(logLine) {
            if (logLine.includes('âœ…') || logLine.includes('æˆåŠŸ')) return '#10b981'; // ç»¿è‰²
            if (logLine.includes('âŒ') || logLine.includes('å¤±è´¥') || logLine.includes('é”™è¯¯')) return '#ef4444'; // çº¢è‰²
            if (logLine.includes('âš ï¸') || logLine.includes('è­¦å‘Š') || logLine.includes('è·³è¿‡')) return '#f59e0b'; // é»„è‰²
            if (logLine.includes('ğŸš¨') || logLine.includes('è­¦æŠ¥')) return '#dc2626'; // æ·±çº¢è‰²
            if (logLine.includes('ğŸ“Š') || logLine.includes('ğŸ“‹') || logLine.includes('ğŸ”')) return '#3b82f6'; // è“è‰²
            if (logLine.includes('ğŸ•·ï¸') || logLine.includes('ğŸŒ') || logLine.includes('ğŸ”„')) return '#8b5cf6'; // ç´«è‰²
            if (logLine.includes('ğŸ“§') || logLine.includes('ğŸ’¾')) return '#06b6d4'; // é’è‰²
            return '#e5e7eb'; // é»˜è®¤ç°è‰²
        }

        // è·å–æœåŠ¡å™¨æ—¥å¿—
        async function fetchServerLogs() {
            try {
                // è¿™é‡Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨çŠ¶æ€APIæ¥æ¨¡æ‹Ÿæ—¥å¿—è·å–
                // å®é™…é¡¹ç›®ä¸­å¯ä»¥åˆ›å»ºä¸“é—¨çš„æ—¥å¿—API
                const response = await fetch(`${API_BASE}/api/status/logs`);
                if (response.ok) {
                    const logs = await response.text();
                    return logs;
                } else {
                    // å¦‚æœæ²¡æœ‰ä¸“é—¨çš„æ—¥å¿—APIï¼Œä½¿ç”¨çŠ¶æ€ä¿¡æ¯ç”Ÿæˆæ¨¡æ‹Ÿæ—¥å¿—
                    return generateMockLogs();
                }
            } catch (error) {
                console.error('è·å–æ—¥å¿—å¤±è´¥:', error);
                return generateMockLogs();
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿæ—¥å¿—ï¼ˆåŸºäºå½“å‰çŠ¶æ€ï¼‰
        function generateMockLogs() {
            const timestamp = new Date().toLocaleString('zh-CN');
            const logs = [
                `[${timestamp}] ğŸ“Š ç³»ç»Ÿè¿è¡Œæ­£å¸¸`,
                `[${timestamp}] ğŸ”„ ç›‘æ§æœåŠ¡å·²å¯åŠ¨`,
                `[${timestamp}] âœ… é…ç½®åŠ è½½æˆåŠŸ`,
                `[${timestamp}] ğŸ“‹ ç›‘æ§é¡¹ç›®: ${currentConfig?.coins?.length || 0} ä¸ª`,
                `[${timestamp}] ğŸ” çŠ¶æ€æ£€æŸ¥å®Œæˆ`
            ];
            return logs.join('\n');
        }

        // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
        async function updateLogs() {
            const logContainer = document.getElementById('logContainer');
            const logs = await fetchServerLogs();

            if (logs) {
                const logLines = logs.split('\n').filter(line => line.trim());
                let html = '';

                // åè½¬æ—¥å¿—æ•°ç»„ï¼Œè®©æœ€æ–°çš„åœ¨ä¸Šé¢
                logLines.reverse().forEach(line => {
                    const color = getLogColor(line);
                    html += `<div style="color: ${color}; margin-bottom: 2px;">${line}</div>`;
                });

                logContainer.innerHTML = html;
            }
        }

        // å¤åˆ¶æ—¥å¿—
        async function copyLogs() {
            const logContainer = document.getElementById('logContainer');
            const logs = await fetchServerLogs();

            if (logs) {
                try {
                    await navigator.clipboard.writeText(logs);
                    showAlert('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } catch (error) {
                    // å¦‚æœå‰ªè´´æ¿APIä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                    const textArea = document.createElement('textarea');
                    textArea.value = logs;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showAlert('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }
            } else {
                showAlert('æ²¡æœ‰å¯å¤åˆ¶çš„æ—¥å¿—', 'error');
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        async function clearLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/status/logs/clear`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('ç³»ç»Ÿæ—¥å¿—å·²æ¸…ç©º', 'success');

                    // æ¸…ç©ºæ˜¾ç¤º
                    const logContainer = document.getElementById('logContainer');
                    logContainer.innerHTML = '<div style="color: #9ca3af; text-align: center;">æ—¥å¿—å·²æ¸…ç©º</div>';
                } else {
                    const error = await response.json();
                    showAlert(`æ¸…ç©ºæ—¥å¿—å¤±è´¥: ${error.message || error.error}`, 'error');
                }
            } catch (error) {
                showAlert(`æ¸…ç©ºæ—¥å¿—å¤±è´¥: ${error.message}`, 'error');
                // å³ä½¿æœåŠ¡ç«¯å¤±è´¥ï¼Œä¹Ÿæ¸…ç©ºå‰ç«¯æ˜¾ç¤º
                const logContainer = document.getElementById('logContainer');
                logContainer.innerHTML = '<div style="color: #9ca3af; text-align: center;">æ—¥å¿—å·²æ¸…ç©ºï¼ˆä»…å‰ç«¯ï¼‰</div>';
            }
        }

    
        // å¼€å§‹æ—¥å¿—è½®è¯¢ï¼ˆæ”¹ä¸ºæ‰‹åŠ¨åˆ·æ–°ï¼‰
        function startLogPolling() {
            updateLogs(); // åªæ›´æ–°ä¸€æ¬¡ï¼Œä¸è‡ªåŠ¨è½®è¯¢
        }

        // åœæ­¢æ—¥å¿—è½®è¯¢
        function stopLogPolling() {
            if (logUpdateInterval) {
                clearInterval(logUpdateInterval);
                logUpdateInterval = null;
            }
        }

        // ä¿®æ”¹triggerMonitoringå‡½æ•°ï¼Œåœ¨æ‰‹åŠ¨è§¦å‘æ—¶å¢åŠ æ—¥å¿—è·å–é¢‘ç‡
        const originalTriggerMonitoring = triggerMonitoring;
        triggerMonitoring = async function() {
            // å¢åŠ æ—¥å¿—æ›´æ–°é¢‘ç‡
            stopLogPolling();
            const fastPollInterval = setInterval(updateLogs, 1000); // æ¯ç§’æ›´æ–°

            try {
                await originalTriggerMonitoring();
            } finally {
                // 3ç§’åæ¢å¤æ­£å¸¸è½®è¯¢é¢‘ç‡
                setTimeout(() => {
                    clearInterval(fastPollInterval);
                    // ä¸å†æ¢å¤è‡ªåŠ¨è½®è¯¢
                }, 3000);
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æ—¥å¿—è½®è¯¢
        document.addEventListener('DOMContentLoaded', function() {
            startLogPolling();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopLogPolling();
        });
    </script>
</body>
</html>