<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinGlass 利率监控</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #fafbfc;
            padding: 12px;
            line-height: 1.5;
            color: #2d3748;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .header {
            background: #f8fafc;
            color: #4a5568;
            padding: 16px 20px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .header h1 {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .header p {
            font-size: 0.875em;
            color: #718096;
        }

        .content {
            padding: 20px;
        }

        .section {
            margin-bottom: 12px;
            padding-bottom: 8px;
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            color: #4a5568;
            font-size: 0.875em;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.9em;
            background: #ffffff;
            transition: border-color 0.15s ease;
        }

        /* 确保时间输入框使用相同的字体大小 */
        input[type="time"] {
            font-size: 0.9em;
        }

        /* 为下拉框添加合适的右侧padding，给下拉箭头留出空间 */
        select {
            padding-right: 28px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
        }

        /* 时间输入框的图标前置和文字缩进 */
        input[type="time"] {
            padding-left: 24px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='12' cy='12' r='10'%3e%3c/circle%3e%3cpolyline points='12,6 12,12 16,14'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 5px center;
            background-size: 12px;
        }

        /* 隐藏浏览器默认的时间图标 */
        input[type="time"]::-webkit-calendar-picker-indicator {
            display: none;
        }

      
        input:focus, select:focus {
            outline: none;
            border-color: #718096;
            box-shadow: 0 0 0 1px #718096;
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 18px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: .15s ease;
            border-radius: 18px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .15s ease;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        input:checked + .slider {
            background-color: #718096;
        }

        input:checked + .slider:before {
            transform: translateX(18px);
        }

        /* 监控激活时的绿色主题 */
        .monitoring-active input:checked + .slider {
            background-color: #22c55e;
        }

        .btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.9em;
            cursor: pointer;
            width: 100%;
            border-radius: 4px;
            font-weight: 500;
            transition: background-color 0.15s ease;
        }

        .btn:hover {
            background: #2d3748;
        }

        .btn.secondary {
            background: #718096;
        }

        .btn.secondary:hover {
            background: #4a5568;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #fef5e7;
            border: 1px solid #f9e79f;
            padding: 12px 16px;
            margin-bottom: 8px;
            color: #7d6608;
            font-size: 0.9em;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        .success {
            background: #eafaf1;
            border: 1px solid #a9dfbf;
            color: #239b56;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading {
            text-align: center;
            padding: 16px;
            color: #718096;
            font-size: 0.9em;
        }

        .main-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 12px 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .main-toggle.monitoring-active {
            background: #f0fdf4;
            border: 1px solid #86efac;
        }

        .main-toggle h3 {
            color: #2d3748;
            font-size: 1em;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .main-toggle.monitoring-active h3 {
            color: #166534;
        }

        /* 监控列表样式 */
        .monitor-list {
            margin-top: 12px;
        }

        .monitor-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .monitor-info {
            flex: 1;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .monitor-info strong {
            color: #2d3748;
            font-size: 1em;
        }

        .monitor-info .timeframe {
            color: #718096;
            font-weight: normal;
            font-size: 1em;
        }

        .monitor-info small {
            color: #718096;
            font-size: 1em;
        }

        .monitor-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remove-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
        }

        .remove-btn:hover {
            background: #c53030;
        }

        .more-menu {
            position: relative;
            display: inline-block;
        }

        .more-btn {
            background: #ffffff;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
        }

        .more-btn:hover {
            background: #f8fafc;
            border-color: #a0aec0;
        }

        .more-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }

        .more-dropdown.show {
            display: block;
        }

        .more-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.75em;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            color: #374151;
        }

        .more-dropdown-item:hover {
            background: #f3f4f6;
        }

        .more-dropdown-item.danger {
            color: #dc2626;
        }

        .more-dropdown-item.danger:hover {
            background: #fef2f2;
        }

        .cooldown-btn {
            background: #f8fafc;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            margin-right: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .cooldown-btn:hover {
            background: #edf2f7;
            border-color: #a0aec0;
        }

        .cooldown-btn:disabled {
            background: #f7fafc;
            color: #a0aec0;
            border-color: #e2e8f0;
            cursor: not-allowed;
        }

        .cooldown-icon {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }

        /* 监控项信息样式 */
        .monitor-info .secondary-info {
            font-size: 0.8em;
            color: #6b7280;
            line-height: 1.4;
        }

        .monitor-info .status-text {
            font-weight: 600;
        }

        /* 快速添加监控样式 */
        .add-monitor-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .add-monitor-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-monitor-input label {
            min-width: 60px;
            font-size: 0.875em;
            color: #4a5568;
            font-weight: 500;
        }

        .add-monitor-input input,
        .add-monitor-input select {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .add-btn {
            background: #ffffff;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            align-self: flex-start;
        }

        .add-btn:hover {
            background: #f8fafc;
            border-color: #718096;
        }

        .icon-btn {
            background: #ffffff;
            color: #718096;
            border: 1px solid #cbd5e0;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            line-height: 1;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover:not(:disabled) {
            background: #f8fafc;
            border-color: #718096;
            color: #4a5568;
        }

        .icon-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* 两栏布局样式 */
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        @media (max-width: 900px) {
            .two-column-layout {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        @media (max-width: 600px) {
            .content {
                padding: 16px;
            }
            .add-monitor-row {
                flex-direction: column;
                gap: 8px;
            }
            .add-monitor-row input,
            .add-monitor-row select {
                min-width: auto;
            }
            .time-inputs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CoinGlass 利率监控</h1>
            <p>实时监控币种借贷利率</p>
        </div>

        <div class="content">
            <div id="alerts"></div>

            <!-- 主监控开关 -->
            <div class="section">
                <div class="main-toggle" id="mainToggleContainer">
                    <h3 id="monitorStatusTitle">监控状态</h3>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mainToggle" onchange="handleMainToggleChange()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- 两栏布局 -->
            <div class="two-column-layout">
                <!-- 左栏：监控项目管理 -->
                <div class="left-column">
                    <!-- 添加监控 -->
                    <div class="section">
                        <h2>添加监控</h2>

                        <div class="add-monitor-row">
                            <div class="add-monitor-input">
                                <label>交易所:</label>
                                <select id="quickExchange">
                                    <option value="binance">Binance</option>
                                    <option value="okx">OKX</option>
                                    <option value="bybit">Bybit</option>
                                </select>
                            </div>

                            <div class="add-monitor-input">
                                <label>币种:</label>
                                <input type="text" id="quickCoin" placeholder="币种" value="USDT">
                            </div>

                            <div class="add-monitor-input">
                                <label>颗粒度:</label>
                                <select id="quickTimeframe">
                                    <option value="1h">每小时</option>
                                    <option value="24h">每天</option>
                                </select>
                            </div>

                            <div class="add-monitor-input">
                                <label>阈值%:</label>
                                <input type="number" id="quickThreshold" placeholder="阈值%" step="0.1" min="0">
                            </div>

                            <button onclick="addMonitor()" class="btn" style="width: 100%;">添加监控</button>
                        </div>
                    </div>

                    <!-- 监控列表 -->
                    <div class="section">
                        <div style="display: flex; align-items: center; margin-bottom: 12px; gap: 8px;">
                            <h2 style="margin: 0;">监控列表</h2>
                            <button id="triggerBtn" onclick="triggerMonitoring()" class="icon-btn" title="立即触发">▶</button>
                            <span id="triggerStatus" style="font-size: 12px; color: #6b7280; display: none;"></span>
                        </div>
                        <div id="monitorList" class="monitor-list">
                            <p style="text-align: center; color: #6b7280;">暂无监控项目</p>
                        </div>
                    </div>
                </div>

                <!-- 右栏：通知设置 -->
                <div class="right-column">
                    <!-- 通知设置 -->
                    <div class="section">
                        <h2>通知设置</h2>

                        <div class="form-group">
                            <label for="email">通知邮箱</label>
                            <input type="email" id="email" placeholder="your-email@example.com" onchange="autoSaveConfig()">
                        </div>

                        <div class="form-group">
                            <label for="repeatInterval">重复通知间隔 (分钟)</label>
                            <input type="number" id="repeatInterval" min="1" max="10080" value="180" placeholder="180" onchange="autoSaveConfig()">
                        </div>

                        <div class="form-group">
                            <label for="hourlyMinute">每小时触发时机 (分钟)</label>
                            <input type="number" id="hourlyMinute" min="0" max="59" value="5" placeholder="5" onchange="autoSaveConfig()">
                        </div>

                        <div class="form-group">
                            <label for="dailyTime">每天触发时机 (H:MM)</label>
                            <input type="time" id="dailyTime" value="09:05" onchange="autoSaveConfig()">
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="timeControl" style="width: auto; margin-right: 8px;" onchange="toggleTimeInputs(); autoSaveConfig()">
                                启用时间限制
                            </label>
                        </div>

                        <div id="timeInputs" style="display: none;">
                            <div class="form-group">
                                <label for="startTime">开始时间</label>
                                <input type="time" id="startTime" value="09:00" onchange="autoSaveConfig()">
                            </div>

                            <div class="form-group">
                                <label for="endTime">结束时间</label>
                                <input type="time" id="endTime" value="23:59" onchange="autoSaveConfig()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 日志容器 -->
            <div class="section">
                <h2>系统日志
                    <div style="float: right;">
                        <button onclick="copyLogs()" style="font-size: 12px; padding: 4px 8px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; margin-right: 4px;">复制</button>
                        <button onclick="clearLogs()" style="font-size: 12px; padding: 4px 8px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer;">清空</button>
                    </div>
                </h2>
                <div id="logContainer" style="background: #1a1a1a; color: #ffffff; padding: 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; height: 350px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #374151;">
                    <div style="color: #9ca3af; text-align: center;">等待系统日志...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Web界面逻辑 - 恢复原始实现
        const API_BASE = window.location.origin;
        let currentConfig = null;

        // 从环境变量加载前端配置（通过全局变量注入）
        const frontendConfig = {
          updateInterval: parseInt(window.FRONTEND_UPDATE_INTERVAL) || 30000,
          apiRequestTimeout: parseInt(window.FRONTEND_API_REQUEST_TIMEOUT) || 10000,
          logRefreshInterval: parseInt(window.FRONTEND_LOG_REFRESH_INTERVAL) || 1000
        };

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 先加载配置，然后加载状态
            loadConfig().then(() => {
                loadStatus();
            }).catch(() => {
                // 如果配置加载失败，仍然尝试加载状态
                loadStatus();
            });

            // 按配置间隔更新状态，保持触发按钮状态
            setInterval(() => loadStatus(true), frontendConfig.updateInterval);
        });

        // 添加监控
        function addMonitor() {
            const exchange = document.getElementById('quickExchange').value;
            const coin = document.getElementById('quickCoin').value.trim().toUpperCase();
            const timeframe = document.getElementById('quickTimeframe').value;
            const threshold = parseFloat(document.getElementById('quickThreshold').value);

            // 验证输入
            if (!coin) {
                showAlert('请输入币种');
                return;
            }

            if (!threshold || threshold <= 0) {
                showAlert('请输入有效的阈值');
                return;
            }

            // 获取当前配置
            const config = currentConfig || {};
            if (!config.coins) config.coins = [];

            // 检查是否已存在相同的监控
            const exists = config.coins.some(c =>
                c.symbol === coin && c.exchange === exchange && c.timeframe === timeframe
            );

            if (exists) {
                showAlert('该监控已存在');
                return;
            }

            // 添加新监控
            config.coins.push({
                symbol: coin,
                exchange: exchange,
                timeframe: timeframe,
                threshold: threshold,
                enabled: true
            });

            // 保存配置
            saveConfig(config);

            // 清空输入
            document.getElementById('quickCoin').value = '';
            document.getElementById('quickThreshold').value = '';

            // 检查是否需要询问启用监控
            checkAndAskToEnableMonitoring();

            loadStatus();
            // 更新监控开关状态
            updateMonitoringToggle();
        }

        // 显示提示信息
        function showAlert(message, type = 'error') {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;

            // 计算垂直位置，让通知垂直排列
            const existingAlerts = document.querySelectorAll('.alert');
            const topOffset = 20 + (existingAlerts.length * 60); // 每个通知间隔60px
            alert.style.top = `${topOffset}px`;

            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    alert.remove();
                    // 重新排列剩余的通知
                    rearrangeAlerts();
                }, 300);
            }, 5000);
        }

        // 重新排列通知位置
        function rearrangeAlerts() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach((alert, index) => {
                const topOffset = 20 + (index * 60);
                alert.style.top = `${topOffset}px`;
            });
        }

        // 加载配置
        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/config`);
                const config = await response.json();

                if (config && Object.keys(config).length > 0) {
                    currentConfig = config;
                    populateForm(config);
                    showAlert('配置加载成功', 'success');
                    return config;
                }
                return null;
            } catch (error) {
                console.error('加载配置失败:', error);
                showAlert('加载配置失败，请重试');
                return null;
            }
        }

        // 填充表单
        function populateForm(config) {
            document.getElementById('email').value = config.email || '';
            document.getElementById('repeatInterval').value = config.repeat_interval || 180;
            document.getElementById('mainToggle').checked = config.monitoring_enabled || false;

            // 填充触发时间设置
            if (config.trigger_settings) {
                document.getElementById('hourlyMinute').value = config.trigger_settings.hourly_minute || 5;
                document.getElementById('dailyTime').value = config.trigger_settings.daily_time || '09:05';
            }

            if (config.notification_hours) {
                document.getElementById('timeControl').checked = config.notification_hours.enabled || false;
                document.getElementById('startTime').value = config.notification_hours.start || '09:00';
                document.getElementById('endTime').value = config.notification_hours.end || '23:59';
                // 根据复选框状态显示或隐藏时间输入
                toggleTimeInputs();
            }

            // 更新监控开关状态
            updateMonitoringToggle();
        }

        // 保存配置
        async function saveConfig(inputConfig = null) {
            const config = inputConfig || {
                email: document.getElementById('email').value,
                repeat_interval: parseInt(document.getElementById('repeatInterval').value),
                monitoring_enabled: document.getElementById('mainToggle').checked,
                trigger_settings: {
                    hourly_minute: parseInt(document.getElementById('hourlyMinute').value) || 5,
                    daily_time: document.getElementById('dailyTime').value || '09:05'
                },
                notification_hours: {
                    enabled: document.getElementById('timeControl').checked,
                    start: document.getElementById('startTime').value,
                    end: document.getElementById('endTime').value
                },
                coins: currentConfig?.coins || [] // 保持现有的监控配置
            };

            try {
                const response = await fetch(`${API_BASE}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    if (!inputConfig) {
                        showAlert('配置保存成功！', 'success');
                    }
                    currentConfig = config;
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                console.error('保存配置失败:', error);
                if (!inputConfig) {
                    showAlert('保存配置失败，请重试');
                }
            }
        }

        // 加载状态
        async function loadStatus(preserveTriggerState = false) {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();

                updateSystemStatus(true);
                displayStatus(data, preserveTriggerState);
            } catch (error) {
                console.error('加载状态失败:', error);
                updateSystemStatus(false);
                document.getElementById('monitorList').innerHTML =
                    '<p style="text-align: center; color: #ef4444;">状态加载失败</p>';
            }
        }

        // 更新系统状态（简化版）
        function updateSystemStatus(isOnline) {
            // 移除了状态指示器，功能保留但简化
        }

        // 显示监控列表
        function displayStatus(data, preserveTriggerState = false) {
            const container = document.getElementById('monitorList');
            const config = currentConfig || {};

            // 如果配置还未加载，显示加载状态
            if (!currentConfig) {
                container.innerHTML = '<p style="text-align: center; color: #3b82f6;">正在加载配置...</p>';
                return;
            }

            if (!config.coins || config.coins.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">暂无监控项目</p>';
                return;
            }

            // 保存触发按钮状态（如果需要保持）
            let triggerBtnState = null;
            if (preserveTriggerState) {
                const triggerBtn = document.getElementById('triggerBtn');
                const triggerStatus = document.getElementById('triggerStatus');
                if (triggerBtn && triggerBtn.disabled) {
                    triggerBtnState = {
                        disabled: true,
                        text: triggerBtn.textContent,
                        statusText: triggerStatus ? triggerStatus.textContent : '',
                        statusVisible: triggerStatus ? triggerStatus.style.display !== 'none' : false
                    };
                }
            }

            let html = '';

            config.coins.forEach((coin, index) => {
                const state = data.monitoring_status && data.monitoring_status.coins_state && data.monitoring_status.coins_state[coin.symbol] ? data.monitoring_status.coins_state[coin.symbol] : { status: 'normal' };
                const statusClass = state.status === 'alert' ? '#ef4444' :
                                   state.status === 'normal' ? '#10b981' : '#f59e0b';
                const statusText = state.status === 'alert' ? '警报' :
                                  state.status === 'normal' ? '正常' : '冷却中';

                // 格式化时间显示
                const timeframeText = coin.timeframe === '1h' ? '每小时' :
                                    coin.timeframe === '24h' ? '每天' : coin.timeframe;

                // 计算下次通知时间
                let nextNotificationText = '';
                if (state.status === 'alert' && state.next_notification) {
                    const nextTime = new Date(state.next_notification);
                    const now = new Date();
                    const diffMs = nextTime - now;

                    if (diffMs > 0) {
                        const diffMins = Math.floor(diffMs / (1000 * 60));
                        if (diffMins < 60) {
                            nextNotificationText = ' <small style="color: #6b7280;">(' + diffMins + '分钟后通知)</small>';
                        } else {
                            const diffHours = Math.floor(diffMins / 60);
                            const remainingMins = diffMins % 60;
                            if (diffHours < 24) {
                                nextNotificationText = ' <small style="color: #6b7280;">(' + diffHours + '小时' + (remainingMins > 0 ? remainingMins + '分钟' : '') + '后通知)</small>';
                            } else {
                                const diffDays = Math.floor(diffHours / 24);
                                const remainingHours = diffHours % 24;
                                nextNotificationText = ' <small style="color: #6b7280;">(' + diffDays + '天' + (remainingHours > 0 ? remainingHours + '小时' : '') + '后通知)</small>';
                            }
                        }
                    }
                }

                // 判断是否显示冷却期重置选项（只有在冷却中状态时显示）
                const showCooldownOption = state.status !== 'alert' && state.status !== 'normal';

                html += '<div class="monitor-item">' +
                        '<div class="monitor-info">' +
                            '<strong>' + coin.exchange + ' - ' + coin.symbol + '</strong>' +
                            '<div class="secondary-info">' +
                            '阈值: ' + coin.threshold + '% | 颗粒度: ' + timeframeText +
                            nextNotificationText +
                        '</div>' +
                        '</div>' +
                        '<div class="monitor-actions">' +
                            '<div class="more-menu">' +
                                '<button onclick="toggleMoreMenu(' + index + ')" class="more-btn">⋮</button>' +
                                '<div id="moreMenu_' + index + '" class="more-dropdown">' +
                                    (showCooldownOption ?
                                        '<button onclick="togglePause(\'' + coin.symbol + '\', ' + index + ')" class="more-dropdown-item">重置冷却期</button>' : ''
                                    ) +
                                    '<button onclick="editMonitor(' + index + ')" class="more-dropdown-item">编辑</button>' +
                                    '<button onclick="removeMonitor(' + index + ')" class="more-dropdown-item danger">删除</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            });

            container.innerHTML = html;

            // 恢复触发按钮状态
            if (triggerBtnState) {
                const triggerBtn = document.getElementById('triggerBtn');
                const triggerStatus = document.getElementById('triggerStatus');
                if (triggerBtn) {
                    triggerBtn.disabled = triggerBtnState.disabled;
                    triggerBtn.textContent = triggerBtnState.text;
                }
                if (triggerStatus && triggerBtnState.statusVisible) {
                    triggerStatus.style.display = 'inline';
                    triggerStatus.textContent = triggerBtnState.statusText;
                }
            }
        }

  
        // 编辑监控
        function editMonitor(index) {
            // 关闭菜单
            closeAllMoreMenus();

            const config = currentConfig || {};
            if (config.coins && config.coins[index]) {
                const coin = config.coins[index];
                const currentThreshold = coin.threshold;
                const newThreshold = prompt(`编辑 ${coin.exchange} - ${coin.symbol} 的阈值:`, currentThreshold);

                if (newThreshold !== null) {
                    const parsedThreshold = parseFloat(newThreshold);
                    if (!isNaN(parsedThreshold) && parsedThreshold > 0) {
                        config.coins[index].threshold = parsedThreshold;
                        saveConfig(config);
                        showAlert('阈值已更新', 'success');
                        loadStatus();
                    } else {
                        showAlert('请输入有效的阈值数值', 'error');
                    }
                }
            }
        }

        // 删除监控
        function removeMonitor(index) {
            // 关闭菜单
            closeAllMoreMenus();

            const config = currentConfig || {};
            if (config.coins && config.coins[index]) {
                const coin = config.coins[index];
                if (confirm('确定要删除监控 ' + coin.exchange + ' - ' + coin.symbol + ' 吗？')) {
                    config.coins.splice(index, 1);
                    saveConfig(config);
                    showAlert('监控已删除', 'success');
                    loadStatus();
                    // 更新监控开关状态
                    updateMonitoringToggle();
                }
            }
        }

        // 切换更多菜单
        function toggleMoreMenu(index) {
            // 关闭所有其他菜单
            const allMenus = document.querySelectorAll('.more-dropdown');
            allMenus.forEach(menu => {
                if (menu.id !== `moreMenu_${index}`) {
                    menu.classList.remove('show');
                }
            });

            // 切换当前菜单
            const currentMenu = document.getElementById(`moreMenu_${index}`);
            if (currentMenu) {
                currentMenu.classList.toggle('show');
            }
        }

        // 关闭所有更多菜单
        function closeAllMoreMenus() {
            const allMenus = document.querySelectorAll('.more-dropdown');
            allMenus.forEach(menu => {
                menu.classList.remove('show');
            });
        }

        // 暂停/继续通知
        async function togglePause(coinSymbol, menuIndex) {
            // 关闭菜单
            closeAllMoreMenus();
            try {
                const response = await fetch(`${API_BASE}/api/status/cooldown/reset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ coinSymbol })
                });

                const result = await response.json();

                if (result.success) {
                    // 刷新状态显示，不显示提示
                    loadStatus();
                } else {
                    // 静默失败，不显示错误
                    console.log('暂停/继续操作失败:', result.message);
                }
            } catch (error) {
                // 静默失败
                console.error('暂停/继续操作失败:', error);
            }
        }

        // 切换时间输入显示
        function toggleTimeInputs() {
            const timeControl = document.getElementById('timeControl');
            const timeInputs = document.getElementById('timeInputs');

            if (timeControl.checked) {
                timeInputs.style.display = 'block';
            } else {
                timeInputs.style.display = 'none';
            }
        }

        // 检查监控状态是否可以开启
        function canEnableMonitoring() {
            const email = document.getElementById('email').value.trim();
            const config = currentConfig || {};
            const hasCoins = config.coins && config.coins.length > 0;

            // 检查邮箱格式是否有效
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isValidEmail = !email || emailRegex.test(email);

            return isValidEmail && hasCoins;
        }

        // 处理主监控开关点击
        function handleMainToggleChange() {
            const mainToggle = document.getElementById('mainToggle');
            const canEnable = canEnableMonitoring();

            if (mainToggle.checked && !canEnable) {
                // 阻止开启监控
                mainToggle.checked = false;
                showEnableMonitoringError();
                return;
            }

            // 如果可以开启，则保存配置
            autoSaveConfig();
        }

        // 检查并询问启用监控
        function checkAndAskToEnableMonitoring() {
            const email = document.getElementById('email').value.trim();
            const mainToggle = document.getElementById('mainToggle');
            const config = currentConfig || {};
            const coinCount = config.coins ? config.coins.length : 0;

            // 如果邮箱已填写，监控未开启，且这是第一条监控
            if (email && !mainToggle.checked && coinCount === 1) {
                setTimeout(() => {
                    if (confirm('监控添加成功！是否立即开启监控？')) {
                        mainToggle.checked = true;
                        autoSaveConfig();
                        showAlert('监控已启用，系统将按配置执行检查', 'success');
                    } else {
                        showAlert('监控添加成功！请记得开启监控开关以开始监控', 'success');
                    }
                }, 500);
            } else {
                // 其他情况显示常规提示
                showAlert('监控添加成功！' + getMonitoringEnabledTip(), 'success');
            }
        }

        // 获取监控启用提示信息
        function getMonitoringEnabledTip() {
            const email = document.getElementById('email').value.trim();
            const mainToggle = document.getElementById('mainToggle');
            const isEnabled = mainToggle.checked;

            if (!email && !isEnabled) {
                return ' 请填写通知邮箱并开启监控开关以开始监控';
            } else if (!email) {
                return ' 请填写通知邮箱以接收监控通知';
            } else if (!isEnabled) {
                return ' 请开启监控开关以开始监控';
            } else {
                return ' 监控已启用，系统将按配置执行检查';
            }
        }

        // 显示具体的启用错误提示
        function showEnableMonitoringError() {
            const email = document.getElementById('email').value.trim();
            const config = currentConfig || {};
            const hasCoins = config.coins && config.coins.length > 0;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isValidEmail = !email || emailRegex.test(email);

            if (!isValidEmail && !hasCoins) {
                if (!email) {
                    showAlert('请先填写通知邮箱并添加监控项目', 'error');
                } else {
                    showAlert('请填写有效的通知邮箱并添加监控项目', 'error');
                }
            } else if (!isValidEmail) {
                if (!email) {
                    showAlert('请先填写通知邮箱', 'error');
                } else {
                    showAlert('请填写有效的通知邮箱', 'error');
                }
            } else if (!hasCoins) {
                showAlert('请先添加监控项目', 'error');
            }
        }

        // 更新监控开关状态
        function updateMonitoringToggle() {
            const mainToggle = document.getElementById('mainToggle');
            const container = document.getElementById('mainToggleContainer');
            const title = document.getElementById('monitorStatusTitle');
            const canEnable = canEnableMonitoring();

            if (!canEnable && mainToggle.checked) {
                // 如果当前开启但不满足条件，自动关闭
                mainToggle.checked = false;
                showAlert('监控已自动关闭：需要配置通知邮箱和监控项目', 'error');
                // 保存配置
                autoSaveConfig();
            }

            // 不禁用开关，但改变样式来提示用户
            if (!canEnable) {
                mainToggle.style.opacity = '0.5';
                // 不设置disabled，保持可点击
            } else {
                mainToggle.style.opacity = '1';
            }

            // 更新监控激活状态的视觉反馈
            if (mainToggle.checked && canEnable) {
                container.classList.add('monitoring-active');
                title.textContent = '利率变化监控中...';
            } else {
                container.classList.remove('monitoring-active');
                title.textContent = '监控状态：未开启';
            }
        }

        // 自动保存配置
        async function autoSaveConfig() {
            const config = {
                email: document.getElementById('email').value,
                repeat_interval: parseInt(document.getElementById('repeatInterval').value),
                monitoring_enabled: document.getElementById('mainToggle').checked,
                trigger_settings: {
                    hourly_minute: parseInt(document.getElementById('hourlyMinute').value) || 5,
                    daily_time: document.getElementById('dailyTime').value || '09:05'
                },
                notification_hours: {
                    enabled: document.getElementById('timeControl').checked,
                    start: document.getElementById('startTime').value,
                    end: document.getElementById('endTime').value
                },
                coins: currentConfig?.coins || []
            };

            // 检查监控状态规则
            const canEnable = canEnableMonitoring();
            if (config.monitoring_enabled && !canEnable) {
                config.monitoring_enabled = false;
                document.getElementById('mainToggle').checked = false;
                showAlert('监控开启失败：需要配置通知邮箱和监控项目', 'error');
            }

            try {
                const response = await fetch(`${API_BASE}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    currentConfig = config;
                    showAlert('配置保存成功', 'success');
                    // 更新监控开关状态
                    updateMonitoringToggle();
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                console.error('自动保存配置失败:', error);
                showAlert('配置保存失败，请重试');
            }
        }

        // 立即触发监控
        async function triggerMonitoring() {
            const triggerBtn = document.getElementById('triggerBtn');
            const triggerStatus = document.getElementById('triggerStatus');

            // 检查按钮是否已经在执行中
            if (triggerBtn.disabled) {
                return;
            }

            try {
                // 禁用按钮并显示进度
                triggerBtn.disabled = true;
                triggerBtn.style.opacity = '0.5';
                triggerBtn.textContent = '⏳';
                triggerStatus.style.display = 'inline';
                triggerStatus.textContent = '正在启动浏览器...';

                showAlert('正在触发监控检查...', 'info');

                // 启动进度更新序列（基于完整监控流程）
                const progressSteps = [
                    { time: 1000, text: '访问CoinGlass页面...' },
                    { time: 3000, text: '切换交易所...' },
                    { time: 5000, text: '选择币种...' },
                    { time: 7000, text: '提取数据...' },
                    { time: 9000, text: '检查阈值条件...' },
                    { time: 11000, text: '发送通知邮件...' }
                ];

                const progressTimers = [];
                progressSteps.forEach(step => {
                    const timer = setTimeout(() => {
                        if (triggerBtn.disabled) {
                            triggerStatus.textContent = step.text;
                        }
                    }, step.time);
                    progressTimers.push(timer);
                });

                // 调用正确的API端点
                const response = await fetch(`${API_BASE}/api/scrape/coinglass`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                // 清除所有进度定时器
                progressTimers.forEach(timer => clearTimeout(timer));

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // 显示成功状态
                triggerStatus.textContent = '完成！';
                triggerBtn.textContent = '✓';
                triggerBtn.style.color = '#10b981';

                // 根据监控结果显示详细的成功消息
                let successMessage = '监控触发成功！';
                if (data.monitor_results) {
                  const { alerts_sent, recoveries_sent, coins_checked } = data.monitor_results;
                  if (alerts_sent > 0) {
                    successMessage += ` 已发送 ${alerts_sent} 个警报通知`;
                  } else if (recoveries_sent > 0) {
                    successMessage += ` 已发送 ${recoveries_sent} 个恢复通知`;
                  } else {
                    successMessage += ` 检查了 ${coins_checked} 个币种，利率正常`;
                  }
                }

                showAlert(successMessage, 'success');

                // 触发后刷新状态
                setTimeout(() => {
                    loadStatus();
                }, 2000);

                // 3秒后恢复按钮状态
                setTimeout(() => {
                    resetTriggerButton();
                }, 3000);

            } catch (error) {
                console.error('触发监控失败:', error);

                // 显示错误状态
                triggerStatus.textContent = '失败';
                triggerBtn.textContent = '✗';
                triggerBtn.style.color = '#ef4444';

                showAlert(`触发监控失败: ${error.message}`, 'error');

                // 3秒后恢复按钮状态
                setTimeout(() => {
                    resetTriggerButton();
                }, 3000);
            }
        }

        // 恢复触发按钮状态的函数
        function resetTriggerButton() {
            const triggerBtn = document.getElementById('triggerBtn');
            const triggerStatus = document.getElementById('triggerStatus');

            if (triggerBtn) {
                triggerBtn.disabled = false;
                triggerBtn.style.opacity = '1';
                triggerBtn.style.color = '';
                triggerBtn.textContent = '▶';
            }

            if (triggerStatus) {
                triggerStatus.style.display = 'none';
                triggerStatus.textContent = '';
            }
        }

        // 日志功能相关变量和函数
        let logUpdateInterval = null;
        let lastLogCount = 0;

        // 颜色映射函数 - 根据日志内容设置颜色
        function getLogColor(logLine) {
            if (logLine.includes('✅') || logLine.includes('成功')) return '#10b981'; // 绿色
            if (logLine.includes('❌') || logLine.includes('失败') || logLine.includes('错误')) return '#ef4444'; // 红色
            if (logLine.includes('⚠️') || logLine.includes('警告') || logLine.includes('跳过')) return '#f59e0b'; // 黄色
            if (logLine.includes('🚨') || logLine.includes('警报')) return '#dc2626'; // 深红色
            if (logLine.includes('📊') || logLine.includes('📋') || logLine.includes('🔍')) return '#3b82f6'; // 蓝色
            if (logLine.includes('🕷️') || logLine.includes('🌐') || logLine.includes('🔄')) return '#8b5cf6'; // 紫色
            if (logLine.includes('📧') || logLine.includes('💾')) return '#06b6d4'; // 青色
            return '#e5e7eb'; // 默认灰色
        }

        // 获取服务器日志
        async function fetchServerLogs() {
            try {
                // 这里我们通过调用状态API来模拟日志获取
                // 实际项目中可以创建专门的日志API
                const response = await fetch(`${API_BASE}/api/status/logs`);
                if (response.ok) {
                    const logs = await response.text();
                    return logs;
                } else {
                    // 如果没有专门的日志API，使用状态信息生成模拟日志
                    return generateMockLogs();
                }
            } catch (error) {
                console.error('获取日志失败:', error);
                return generateMockLogs();
            }
        }

        // 生成模拟日志（基于当前状态）
        function generateMockLogs() {
            const timestamp = new Date().toLocaleString('zh-CN');
            const logs = [
                `[${timestamp}] 📊 系统运行正常`,
                `[${timestamp}] 🔄 监控服务已启动`,
                `[${timestamp}] ✅ 配置加载成功`,
                `[${timestamp}] 📋 监控项目: ${currentConfig?.coins?.length || 0} 个`,
                `[${timestamp}] 🔍 状态检查完成`
            ];
            return logs.join('\n');
        }

        // 更新日志显示
        async function updateLogs() {
            const logContainer = document.getElementById('logContainer');
            const logs = await fetchServerLogs();

            if (logs) {
                const logLines = logs.split('\n').filter(line => line.trim());
                let html = '';

                // 反转日志数组，让最新的在上面
                logLines.reverse().forEach(line => {
                    const color = getLogColor(line);
                    html += `<div style="color: ${color}; margin-bottom: 2px;">${line}</div>`;
                });

                logContainer.innerHTML = html;
            }
        }

        // 复制日志
        async function copyLogs() {
            const logContainer = document.getElementById('logContainer');
            const logs = await fetchServerLogs();

            if (logs) {
                try {
                    await navigator.clipboard.writeText(logs);
                    showAlert('日志已复制到剪贴板', 'success');
                } catch (error) {
                    // 如果剪贴板API不可用，使用传统方法
                    const textArea = document.createElement('textarea');
                    textArea.value = logs;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showAlert('日志已复制到剪贴板', 'success');
                }
            } else {
                showAlert('没有可复制的日志', 'error');
            }
        }

        // 清空日志
        async function clearLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/status/logs/clear`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('系统日志已清空', 'success');

                    // 清空显示
                    const logContainer = document.getElementById('logContainer');
                    logContainer.innerHTML = '<div style="color: #9ca3af; text-align: center;">日志已清空</div>';
                } else {
                    const error = await response.json();
                    showAlert(`清空日志失败: ${error.message || error.error}`, 'error');
                }
            } catch (error) {
                showAlert(`清空日志失败: ${error.message}`, 'error');
                // 即使服务端失败，也清空前端显示
                const logContainer = document.getElementById('logContainer');
                logContainer.innerHTML = '<div style="color: #9ca3af; text-align: center;">日志已清空（仅前端）</div>';
            }
        }

    
        // 开始日志轮询（改为手动刷新）
        function startLogPolling() {
            updateLogs(); // 只更新一次，不自动轮询
        }

        // 停止日志轮询
        function stopLogPolling() {
            if (logUpdateInterval) {
                clearInterval(logUpdateInterval);
                logUpdateInterval = null;
            }
        }

        // 修改triggerMonitoring函数，在手动触发时增加日志获取频率
        const originalTriggerMonitoring = triggerMonitoring;
        triggerMonitoring = async function() {
            // 增加日志更新频率
            stopLogPolling();
            const fastPollInterval = setInterval(updateLogs, frontendConfig.logRefreshInterval);

            try {
                await originalTriggerMonitoring();
            } finally {
                // 3秒后恢复正常轮询频率
                setTimeout(() => {
                    clearInterval(fastPollInterval);
                    // 不再恢复自动轮询
                }, 3000);
            }
        };

        // 页面加载完成后启动日志轮询
        document.addEventListener('DOMContentLoaded', function() {
            startLogPolling();

            // 点击页面其他地方关闭更多菜单
            document.addEventListener('click', function(event) {
                const isClickInsideMenu = event.target.closest('.more-menu');
                if (!isClickInsideMenu) {
                    closeAllMoreMenus();
                }
            });
        });

        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            stopLogPolling();
        });
    </script>
</body>
</html>